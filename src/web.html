<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>lirik</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸŽµ</text></svg>">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{
  background:#0a0a0a;
  color:#444;
  font-family:'SF Pro Display',-apple-system,BlinkMacSystemFont,'Segoe UI',system-ui,sans-serif;
  height:100vh;
  display:flex;
  flex-direction:column;
  overflow:hidden;
}
#header{
  padding:1.8rem 2rem 1.4rem;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:1.4rem;
  flex-shrink:0;
  border-bottom:1px solid #161616;
}
#art{
  width:64px;height:64px;
  border-radius:8px;
  object-fit:cover;
  flex-shrink:0;
  display:none;
  box-shadow:0 2px 12px rgba(0,0,0,.5);
}
#meta{text-align:left;min-width:0}
#track-name{
  font-size:1.1rem;
  color:#eee;
  font-weight:600;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
#artist-name{
  font-size:.9rem;
  color:#888;
  margin-bottom:.15rem;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
#album-name{
  font-size:.75rem;
  color:#444;
  margin-bottom:.6rem;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
.bar{
  width:280px;
  height:3px;
  background:#1a1a1a;
  border-radius:2px;
  overflow:hidden;
}
.bar-fill{
  height:100%;
  background:linear-gradient(90deg,#5b9a5b,#78c878);
  border-radius:2px;
  width:0%;
  transition:width .3s linear;
}
#time{
  display:flex;
  justify-content:space-between;
  width:280px;
  font-size:.7rem;
  margin-top:.25rem;
  color:#333;
  font-variant-numeric:tabular-nums;
}
#time .elapsed{color:#78c878}
#icon{
  color:#78c878;
  font-size:1.2rem;
  margin-left:.6rem;
  flex-shrink:0;
  opacity:.7;
}
#lyrics{
  flex:1;
  overflow-y:auto;
  text-align:center;
  padding:0 2rem;
  scrollbar-width:none;
}
#lyrics::-webkit-scrollbar{display:none}
.spacer{height:45vh}
.line{
  padding:.4rem 0;
  font-size:1.2rem;
  transition:color .4s,transform .4s,font-size .4s;
  line-height:1.7;
  cursor:default;
}
.line.active{
  color:#78c878;
  font-weight:600;
  font-size:1.45rem;
  transform:scale(1.03);
}
.line.near{color:#555}
.line.far{color:#2a2a2a}
#empty{
  color:#2a2a2a;
  padding-top:30vh;
  font-size:1.1rem;
  letter-spacing:.05em;
}
</style>
</head>
<body>
<div id="header">
  <img id="art" src="" alt="">
  <div id="meta">
    <div id="track-name">-</div>
    <div id="artist-name"></div>
    <div id="album-name"></div>
    <div class="bar"><div class="bar-fill"></div></div>
    <div id="time"><span class="elapsed">-</span><span>-</span></div>
  </div>
  <div id="icon"></div>
</div>
<div id="lyrics"><div id="empty">waiting for music...</div></div>

<script>
let state=null,lastTrack='',lastArt='';

async function poll(){
  try{state=await(await fetch('/api/state')).json()}catch(e){}
}

function progress(){
  if(!state||!state.now_playing)return 0;
  const n=state.now_playing;
  if(!n.is_playing)return n.progress_ms;
  return Math.min(n.progress_ms+(Date.now()-state.fetched_at_ms),n.duration_ms);
}

function fmt(ms){
  const s=Math.floor(ms/1000);
  return Math.floor(s/60)+':'+String(s%60).padStart(2,'0');
}

function findLine(lines,ms){
  let idx=-1;
  for(let i=0;i<lines.length;i++){
    if(lines[i].time_ms<=ms)idx=i;else break;
  }
  return idx;
}

function render(){
  if(!state)return;
  const n=state.now_playing;
  const trackEl=document.getElementById('track-name');
  const artistEl=document.getElementById('artist-name');
  const albumEl=document.getElementById('album-name');
  const artEl=document.getElementById('art');
  const iconEl=document.getElementById('icon');
  const timeEl=document.getElementById('time');
  const fill=document.querySelector('.bar-fill');
  const box=document.getElementById('lyrics');

  if(!n){
    trackEl.textContent='nothing playing';
    artistEl.textContent='';
    albumEl.textContent='';
    artEl.style.display='none';
    iconEl.textContent='';
    timeEl.innerHTML='<span>-</span><span>-</span>';
    fill.style.width='0%';
    document.title='lirik';
    return;
  }

  const p=progress();
  const ratio=n.duration_ms>0?p/n.duration_ms:0;

  trackEl.textContent=n.track;
  artistEl.textContent=n.artist;
  albumEl.textContent=n.album||'';
  iconEl.textContent=n.is_playing?'\u25b6':'\u23f8';

  const art=n.album_art||'';
  if(art&&art!==lastArt){
    lastArt=art;
    artEl.src=art;
    artEl.style.display='block';
  }else if(!art){
    artEl.style.display='none';
    lastArt='';
  }

  timeEl.innerHTML=`<span class="elapsed">${fmt(p)}</span><span>${fmt(n.duration_ms)}</span>`;
  fill.style.width=(ratio*100).toFixed(1)+'%';
  document.title=`${n.artist} \u2014 ${n.track}`;

  const key=n.artist+'\0'+n.track;
  if(key!==lastTrack){
    lastTrack=key;
    if(state.lyrics&&state.lyrics.lines.length){
      box.innerHTML='<div class="spacer"></div>'+
        state.lyrics.lines.map((l,i)=>
          `<div class="line" data-i="${i}">${esc(l.text)||'&nbsp;'}</div>`
        ).join('')+'<div class="spacer"></div>';
    }else{
      box.innerHTML='<div id="empty">no lyrics found</div>';
    }
  }

  if(state.lyrics&&state.lyrics.synced){
    const idx=findLine(state.lyrics.lines,p);
    const els=box.querySelectorAll('.line');
    els.forEach((el,i)=>{
      const d=Math.abs(i-idx);
      el.classList.toggle('active',i===idx);
      el.classList.toggle('near',d>0&&d<=2);
      el.classList.toggle('far',d>2);
    });
    if(idx>=0&&els[idx]){
      els[idx].scrollIntoView({behavior:'smooth',block:'center'});
    }
  }
}

function esc(s){
  const d=document.createElement('div');
  d.textContent=s;return d.innerHTML;
}

setInterval(poll,2000);
setInterval(render,100);
poll();
</script>
</body>
</html>
