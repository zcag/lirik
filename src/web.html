<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>lirik</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸŽµ</text></svg>">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{
  background:#0d0d0d;
  color:#444;
  font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',system-ui,sans-serif;
  height:100vh;
  display:flex;
  flex-direction:column;
  overflow:hidden;
}
#header{
  padding:2rem 2rem 1.5rem;
  text-align:center;
  flex-shrink:0;
}
#track{
  font-size:1.2rem;
  color:#eee;
  margin-bottom:.6rem;
}
#track .artist{font-weight:700}
#track .sep{color:#444}
#track .icon{color:#78c878;margin-left:.3rem}
.bar{
  max-width:500px;
  margin:0 auto;
  height:3px;
  background:#1a1a1a;
  border-radius:2px;
  overflow:hidden;
}
.bar-fill{
  height:100%;
  background:#78c878;
  border-radius:2px;
  width:0%;
  transition:width .15s linear;
}
#time{
  font-size:.8rem;
  margin-top:.4rem;
  color:#444;
}
#time .elapsed{color:#78c878}
#lyrics{
  flex:1;
  overflow-y:auto;
  text-align:center;
  padding:0 2rem;
  scrollbar-width:none;
}
#lyrics::-webkit-scrollbar{display:none}
.spacer{height:45vh}
.line{
  padding:.35rem 0;
  font-size:1.15rem;
  transition:color .3s,transform .3s;
  line-height:1.6;
}
.line.active{
  color:#78c878;
  font-weight:600;
  font-size:1.35rem;
  transform:scale(1.02);
}
.line.near{color:#666}
#empty{
  color:#333;
  padding-top:30vh;
  font-size:1.1rem;
}
</style>
</head>
<body>
<div id="header">
  <div id="track">-</div>
  <div class="bar"><div class="bar-fill"></div></div>
  <div id="time"></div>
</div>
<div id="lyrics"><div id="empty">waiting for music...</div></div>

<script>
let state=null,lastTrack='';

async function poll(){
  try{state=await(await fetch('/api/state')).json()}catch(e){}
}

function progress(){
  if(!state||!state.now_playing)return 0;
  const n=state.now_playing;
  if(!n.is_playing)return n.progress_ms;
  return Math.min(n.progress_ms+(Date.now()-state.fetched_at_ms),n.duration_ms);
}

function fmt(ms){
  const s=Math.floor(ms/1000);
  return Math.floor(s/60)+':'+String(s%60).padStart(2,'0');
}

function findLine(lines,ms){
  let idx=-1;
  for(let i=0;i<lines.length;i++){
    if(lines[i].time_ms<=ms)idx=i;else break;
  }
  return idx;
}

function render(){
  if(!state)return;
  const n=state.now_playing;
  const trackEl=document.getElementById('track');
  const timeEl=document.getElementById('time');
  const fill=document.querySelector('.bar-fill');
  const box=document.getElementById('lyrics');

  if(!n){
    trackEl.textContent='nothing playing';
    timeEl.textContent='';
    fill.style.width='0%';
    document.title='lirik';
    return;
  }

  const p=progress();
  const ratio=n.duration_ms>0?p/n.duration_ms:0;
  const icon=n.is_playing?'\u25b6':'\u23f8';

  trackEl.innerHTML=`<span class="artist">${esc(n.artist)}</span>`+
    `<span class="sep"> \u2014 </span>${esc(n.track)}`+
    `<span class="icon">${icon}</span>`;
  timeEl.innerHTML=`<span class="elapsed">${fmt(p)}</span> / ${fmt(n.duration_ms)}`;
  fill.style.width=(ratio*100).toFixed(1)+'%';
  document.title=`${n.artist} \u2014 ${n.track}`;

  const key=n.artist+'\0'+n.track;
  if(key!==lastTrack){
    lastTrack=key;
    if(state.lyrics&&state.lyrics.lines.length){
      box.innerHTML='<div class="spacer"></div>'+
        state.lyrics.lines.map((l,i)=>
          `<div class="line" data-i="${i}">${esc(l.text)||'&nbsp;'}</div>`
        ).join('')+'<div class="spacer"></div>';
    }else{
      box.innerHTML='<div id="empty">no lyrics found</div>';
    }
  }

  if(state.lyrics&&state.lyrics.synced){
    const idx=findLine(state.lyrics.lines,p);
    const els=box.querySelectorAll('.line');
    els.forEach((el,i)=>{
      const d=Math.abs(i-idx);
      el.classList.toggle('active',i===idx);
      el.classList.toggle('near',d>0&&d<=2);
    });
    if(idx>=0&&els[idx]){
      els[idx].scrollIntoView({behavior:'smooth',block:'center'});
    }
  }
}

function esc(s){
  const d=document.createElement('div');
  d.textContent=s;return d.innerHTML;
}

setInterval(poll,2000);
setInterval(render,100);
poll();
</script>
</body>
</html>
